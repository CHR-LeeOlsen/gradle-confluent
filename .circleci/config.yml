version: 2.1

executors:
  release-build-test-publish: # declares a reusable executor
    machine: true
    working_directory: ~/workspace

jobs:
    release:
        executor: release-build-test-publish
        steps:
            - checkout
            - restore_cache:
                keys:
                    - gradle-{{ checksum "build.gradle" }}-{{ checksum "settings.gradle" }}
            - run: ./gradlew release -Prelease.disableChecks -Prelease.localOnly
    build:
        executor: release-build-test-publish
        steps:
            - run:
                name: Build and Test
                command: ./gradlew build
            - store_artifacts:
                path: build/distributions
                destination: distributions
            - store_artifacts:
                path: build/libs
                destination: libs
    test:
        executor: release-build-test-publish
        steps:
            - run:
                name: Build and Test
                command: ./gradlew build runAllTests
            - save_cache:
                paths:
                    - ~/.gradle
                    - ~/.m2
                key: gradle-{{ checksum "build.gradle" }}-{{ checksum "settings.gradle" }}
            - store_test_results:
                path: build/test-results
    publish:
        executor: release-build-test-publish
        steps:
            - run: ./gradlew publishPlugins githubRelease


workflows:
  version: 2
  release-build-test-publish:
    jobs:
      - release
      - build:
          requires:
            - release
      - test:
          requires:
            - build
      - publish:
          requires:
            - test
